# REVLN_WORKFLOW

## 目的
このファイルは、GitHub Copilot が会話状態のリセット後でも作業を継続できるように、
本プロジェクトの概要および作業ログをリポジトリ上に恒久的に保存する目的で作成されたものです。

---
## ルール
- 手順や段取りはSBYSで進めること。
- 返答は簡潔明瞭に行うこと。
- コードを変更する前に、必ず改修の方針を提示すること。
- 無断でリファクタリングを行わないこと。
- コードの変更は最小限の差分にとどめること。
- 改修を実施する際は、ユーザの承認を得てから行うこと。
- ログが貼り付けられた場合は、何が起きたのか説明し、エラーがある場合はその内容と原因、対処法を提示すること。
- Gitへの書き込み操作 は行わないこと。
- このファイルで`GitHub Copilotが更新`が変更できるのは「現状サマリ」と「作業ログ」のみ。

---
## プロジェクトの概要
MongoDB Atlas が App Services を廃止したことを受けて、その代替手段を提供することを目的とする。
MongoDB Atlas / MongoDB との接続とユーザー認証の仕組みのみを実装し、既存の Realm 依存アプリケーションが最小限のコード変更で移行できるようにする。

---
## 技術構成

### 使用技術
- 言語: TypeScript
- パッケージ管理: pnpm
- データベース接続: MongoDB Node.js Driver
- 認証: JSON Web Tokens (JWT)
- テスト: Jest

### パッケージの構成と役割
モノレポ (monorepo) を使用し、次の3つのパッケージで構成されている
- revlm-server：MongoDB Atlas / MongoDB と接続し、認証とクライアントからのリクエスト仲介を提供
- revlm-client：アプリに組み込んで使用するクライアントライブラリ、revlm-server に接続してデータベースの操作を行う
- revlm-shared：型定義やユーティリティ関数など、revlm-server と revlm-client の共通で使用

各パッケージは独立した npm パッケージとして公開可能な設計

---
## ゴールの定義
1. `build → start → test` までエラー無く正しく動作すること
2. 公開用パッケージ（`dist` と `exports`）を npm に配布し、正しく動作すること。

---
## 現状サマリ（GitHub Copilotが更新）
2025/11/02 日更新

- 現時点で確認できている変更と状況のサマリ:
  - `revlm-shared` の型定義修正が行われ、`revlm-server` 側での参照確認が進んでいる（型の不整合は軽微な調整で解消可能）。
  - `packages/revlm-server` の一部ビルドは成功例があるが、全体のビルド・テストはまだ未完（特にテストの MongoDB 依存があるため環境整備が必要）。
  - 直近で確認されている主要問題点:
    - `start.js` の出力先が不安定で、ビルド成果物の配置が環境によって変わる可能性がある。
    - `tsconfig` の `rootDir` / `include` 設定の衝突（TS6059）が報告されており、ビルド時に余分なファイルが含まれる/除外される問題がある。
    - `node_modules` を削除すると依存解決が壊れる（TS2307 / MODULE_NOT_FOUND が発生するケースあり） — workspace 設定または参照パスが原因の可能性。
    - テストが MongoDB 実インスタンスまたは Atlas に依存している箇所があり、ローカルでの再現性が低い（`mongodb-memory-server` 等の導入で改善可能）。
    - 変更履歴や修正が場当たり的でロールバックしにくい箇所がある（commit 操作は今回行わない方針）。

- 現在の作業ステータス（チェックリスト的表現）:
  - `revlm-shared` の型修正: 一部完了（追加で `composite` 化して `.d.ts` を生成する作業が残る）
  - `revlm-server` のビルド: 部分的成功（追加の型チェック・テスト整備が必要）
  - `revlm-client` のビルド/テスト: 未着手/未確認
  - ルートワークスペースの `pnpm install` / 全体ビルド・テスト: 未検証

- 優先度の高い次のアクション（推奨）:
  1. ワークスペースで `pnpm install` を実行して依存を復元し、環境で再現されるエラーを取得する（ローカルでの再現が最優先）。
  2. `revlm-shared` を `composite: true` にして明示的に `declaration: true` を出力するようにし、`.d.ts` を確実に生成する（`revlm-server`/`revlm-client` の型参照を安定化）。
  3. `tsconfig` の `rootDir` / `include` を見直し、ソースと出力が混在しない最小修正を行う（TS6059 を解消）。
  4. テストで MongoDB が必要なものは `mongodb-memory-server` を検討し、CI/ローカルで再現可能にする。
  5. `start.js` の出力先を明示化する（ビルドスクリプト/tsconfig の outDir 等を最小変更で統一）。

- 既知のリスクと注意点:
  - npm 公開物とテスト時の import パスが変わることがあるため、`exports` / `main` / `types` の設定は慎重に扱う。
  - 修正前に方針提示・承認を必須とする（REVLN_WORKFLOW のルールに従う）。

- 短期目標（今週中に実施したいこと）:
  - `pnpm install` → `revlm-shared` のビルド確認（`.d.ts` 出力の有無を確認）
  - `tsconfig` の rootDir/include による警告（TS6059）の再現と最小修正案の作成
  - Mongo 依存テストの洗い出し（どのテストが実 DB を要求するか）

- ログ／検証のために私が実行できるコマンド一覧（安全な範囲）:
  - ワークスペース依存復元: `pnpm install`
  - `revlm-shared` ビルド: `pnpm --filter @kedaruma/revlm-shared run build`
  - 個別パッケージのテスト: `pnpm --filter @kedaruma/revlm-shared test`（同様に server/client も）
  - 全体ビルド（Project References が設定されている場合）: `pnpm -w run build`

---
## ゴールまでの作業項目
- [ ] revlm-server
  - [x] `packages/revlm-server` で pnpm build が成功すること️
  - [ ] `packages/revlm-server` で pnpm test が成功すること
  - [ ] `packages/revlm-server` で npm 公開物の検証
- [ ] revlm-client
  - [ ] `packages/revlm-client` で pnpm build が成功すること
  - [ ] `packages/revlm-client` で pnpm test が成功すること
  - [ ] `packages/revlm-client` で npm 公開物の検証（`pnpm pack` → 別プロジェクトで import/tsc を確認）
- [ ] revlm-shared
  - [ ] `packages/revlm-shared` で pnpm build が成功すること
  - [ ] `packages/revlm-shared` を `composite` 化し型定義（`.d.ts`）が生成されること
  - [ ] `revlm-server` / `revlm-client` 側で `revlm-shared` を参照してビルド・型チェックが通ること
- [ ] プロジェクト `root`
  - [ ] pnpm install で依存が正しく復元されること
  - [ ] pnpm build で全体ビルドが成功すること
  - [ ] pnpm test で全体テストが成功すること
  - [ ] pnpm install で依存が正しく復元されること
  - [ ] 全体のnpmの公開物の検証（`pnpm pack` → 別プロジェクトで import/tsc を確認）

---
## 注意事項
- npmの公開要件があるので、testとnpm公開状態でimportパスが変わってしまう

---
## 作業ログ（GitHub Copilotが追加）
- YYYY-MM-DD :
  - 改修内容1
  - 改修内容2

## コマンドスニペット（コピペで実行）
### 依存復元
```bash
pnpm install
```

### パッケージ単体ビルド
```bash
pnpm --filter @kedaruma/revlm-shared run build
pnpm --filter @kedaruma/revlm-server run build
```

### Project References（全体ビルド）
```bash
pnpm -w run build
```

### ローカル公開物検証
```bash
cd packages/revlm-shared
pnpm pack
mkdir /tmp/revlm-test && cd /tmp/revlm-test
pnpm init -y
pnpm add /path/to/revlm-shared-1.0.0.tgz
# test プロジェクトで import と実行（または tsc）を検証する
```

---

*ファイル作成日: 2025-11-01*
